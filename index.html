<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paralegal Task Deconstruction Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .subtitle {
            color: var(--secondary-color);
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            height: 100%;
        }
        
        .card h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-color);
        }
        
        .input-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .task-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .task-input-container label {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        textarea {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }
        
        .examples {
            margin-top: 15px;
        }
        
        .examples h3 {
            font-size: 1rem;
            color: var(--secondary-color);
            margin-bottom: 8px;
        }
        
        .example-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .example-btn {
            background-color: var(--light-color);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .example-btn:hover {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-deconstruct {
            background-color: var(--accent-color);
        }
        
        .btn-deconstruct:hover {
            background-color: #c0392b;
        }
        
        .results-area {
            display: flex;
            flex-direction: column;
        }
        
        .task-display {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--secondary-color);
            margin-bottom: 20px;
        }
        
        .breakdown-container {
            flex-grow: 1;
            overflow-y: auto;
            max-height: 500px;
        }
        
        .breakdown-level {
            margin-bottom: 25px;
            position: relative;
        }
        
        .level-header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .level-title {
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .level-count {
            background-color: var(--secondary-color);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .component-list {
            padding-left: 20px;
        }
        
        .component-item {
            background-color: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            border-left: 4px solid #ddd;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        
        .component-item:hover {
            border-left-color: var(--secondary-color);
            transform: translateX(5px);
        }
        
        .component-text {
            flex-grow: 1;
        }
        
        .automation-badge {
            background-color: var(--success-color);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .automation-analysis {
            background-color: #f0f7ff;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 40px;
        }
        
        .automation-analysis h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .analysis-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border-top: 4px solid var(--secondary-color);
        }
        
        .analysis-card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .analysis-card i {
            color: var(--secondary-color);
        }
        
        .analysis-card ul {
            padding-left: 20px;
        }
        
        .analysis-card li {
            margin-bottom: 8px;
        }
        
        .automation-potential {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .potential-bar {
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            flex-grow: 1;
            margin-right: 15px;
            overflow: hidden;
        }
        
        .potential-fill {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 5px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 0.9rem;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .instructions {
            background-color: #fff8e1;
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid #ffc107;
            margin-top: 20px;
            font-size: 0.95rem;
        }
        
        .instructions h3 {
            color: #e65100;
            margin-bottom: 10px;
        }

        /* Settings Panel Styles */
        .settings-panel {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .settings-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .settings-header:hover {
            background-color: #34495e;
        }

        .settings-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-toggle {
            transition: transform 0.3s;
        }

        .settings-toggle.open {
            transform: rotate(180deg);
        }

        .settings-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .settings-content.open {
            max-height: 500px;
        }

        .settings-body {
            padding: 20px;
        }

        .settings-warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .settings-warning i {
            color: #856404;
            margin-top: 2px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-group label {
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.95rem;
        }

        .setting-group input,
        .setting-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .setting-group input:focus,
        .setting-group select:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .setting-group input[type="password"] {
            font-family: monospace;
        }

        .settings-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 10px 18px;
            font-size: 0.9rem;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #219a52;
        }

        /* Audio Input Section */
        .audio-section {
            margin-bottom: 40px;
        }

        .audio-section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-color);
        }

        .audio-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .audio-grid {
                grid-template-columns: 1fr;
            }
        }

        .audio-input-tabs {
            display: flex;
            border-bottom: 2px solid var(--light-color);
            margin-bottom: 20px;
        }

        .audio-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .audio-tab:hover {
            color: var(--secondary-color);
        }

        .audio-tab.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
            font-weight: 600;
        }

        .audio-tab-content {
            display: none;
        }

        .audio-tab-content.active {
            display: block;
        }

        /* File Upload Zone */
        .file-drop-zone {
            border: 3px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #fafafa;
        }

        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: var(--secondary-color);
            background-color: #f0f7ff;
        }

        .file-drop-zone i {
            font-size: 3rem;
            color: #bbb;
            margin-bottom: 15px;
        }

        .file-drop-zone p {
            color: #666;
            margin-bottom: 8px;
        }

        .file-drop-zone .file-types {
            font-size: 0.85rem;
            color: #999;
        }

        .file-input {
            display: none;
        }

        .selected-file {
            margin-top: 15px;
            padding: 12px;
            background-color: #e8f5e9;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .selected-file i {
            color: var(--success-color);
            margin-right: 10px;
        }

        .remove-file {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 5px;
        }

        .remove-file:hover {
            color: var(--accent-color);
        }

        /* Voice Recording */
        .recording-area {
            text-align: center;
            padding: 20px;
        }

        .record-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--accent-color);
            border: none;
            color: white;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .record-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(231, 76, 60, 0.4);
        }

        .record-btn.recording {
            animation: pulse 1.5s infinite;
            background-color: #c0392b;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        .recording-status {
            font-size: 1.1rem;
            color: var(--dark-color);
            margin-bottom: 10px;
        }

        .recording-time {
            font-family: monospace;
            font-size: 1.5rem;
            color: var(--accent-color);
        }

        .recording-hint {
            color: #666;
            font-size: 0.9rem;
            margin-top: 15px;
        }

        /* Transcript Area */
        .transcript-container {
            margin-top: 20px;
        }

        .transcript-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .transcript-header h4 {
            color: var(--primary-color);
            margin: 0;
        }

        .transcript-text {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
        }

        .transcript-text:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        /* Case Intake Form */
        .intake-form-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
        }

        .intake-form-container h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .intake-section {
            margin-bottom: 25px;
        }

        .intake-section h4 {
            color: var(--secondary-color);
            margin-bottom: 15px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .intake-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .intake-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .intake-field label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        .intake-field input,
        .intake-field textarea,
        .intake-field select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .intake-field input:focus,
        .intake-field textarea:focus,
        .intake-field select:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .intake-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .intake-field.full-width {
            grid-column: 1 / -1;
        }

        .intake-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        /* Processing Overlay */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .processing-overlay.active {
            display: flex;
        }

        .processing-modal {
            background-color: white;
            padding: 40px;
            border-radius: var(--border-radius);
            text-align: center;
            max-width: 400px;
        }

        .processing-modal .loading-spinner {
            margin-bottom: 20px;
        }

        .processing-modal h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .processing-modal p {
            color: #666;
        }

        /* Status Messages */
        .status-message {
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            display: none;
        }

        .status-message.show {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-message.error {
            background-color: #fdecea;
            color: #c62828;
            border: 1px solid #f5c6cb;
        }

        .status-message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .status-message.info {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        /* Side Panel Styles */
        .side-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 1000;
        }

        .side-panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .side-panel {
            position: fixed;
            top: 0;
            right: -600px;
            width: 600px;
            max-width: 100%;
            height: 100%;
            background-color: #f5f7fa;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.15);
            transition: right 0.3s ease-out;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .side-panel.active {
            right: 0;
        }

        .side-panel-header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
        }

        .side-panel-header h3 {
            margin: 0;
            font-size: 1.2rem;
            line-height: 1.4;
            padding-right: 15px;
        }

        .side-panel-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .side-panel-close:hover {
            opacity: 1;
        }

        .side-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .side-panel-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .side-panel-section h4 {
            color: var(--primary-color);
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }

        /* Component Audio Tabs in Side Panel */
        .component-audio-tabs {
            display: flex;
            border-bottom: 2px solid var(--light-color);
            margin-bottom: 15px;
        }

        .component-audio-tab {
            padding: 10px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .component-audio-tab:hover {
            color: var(--secondary-color);
        }

        .component-audio-tab.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
            font-weight: 600;
        }

        .component-tab-content {
            display: none;
        }

        .component-tab-content.active {
            display: block;
        }

        /* Compact file drop zone for side panel */
        .compact-drop-zone {
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #fafafa;
        }

        .compact-drop-zone:hover,
        .compact-drop-zone.dragover {
            border-color: var(--secondary-color);
            background-color: #f0f7ff;
        }

        .compact-drop-zone i {
            font-size: 2rem;
            color: #bbb;
            margin-bottom: 10px;
        }

        .compact-drop-zone p {
            color: #666;
            margin: 0;
            font-size: 0.9rem;
        }

        /* Compact recording area */
        .compact-recording {
            text-align: center;
            padding: 15px;
        }

        .compact-record-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: var(--accent-color);
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
        }

        .compact-record-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .compact-record-btn.recording {
            animation: pulse 1.5s infinite;
            background-color: #c0392b;
        }

        /* Component Form Styles */
        .component-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .component-form-grid.two-col {
            grid-template-columns: 1fr 1fr;
        }

        @media (max-width: 500px) {
            .component-form-grid.two-col {
                grid-template-columns: 1fr;
            }
        }

        .component-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .component-field label {
            font-size: 0.85rem;
            color: #555;
            font-weight: 500;
        }

        .component-field input,
        .component-field textarea,
        .component-field select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .component-field input:focus,
        .component-field textarea:focus,
        .component-field select:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .component-field textarea {
            min-height: 70px;
            resize: vertical;
        }

        .component-field.full-width {
            grid-column: 1 / -1;
        }

        /* Clickable component items */
        .component-item.clickable {
            cursor: pointer;
            position: relative;
        }

        .component-item.clickable::after {
            content: '\f054';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 15px;
            color: #ccc;
            transition: all 0.2s;
        }

        .component-item.clickable:hover::after {
            color: var(--secondary-color);
            right: 10px;
        }

        .component-item.clickable:hover {
            background-color: #f8f9fa;
        }

        .component-item.has-data {
            border-left-color: var(--success-color);
        }

        .component-item.has-data .component-text::after {
            content: ' âœ“';
            color: var(--success-color);
            font-weight: bold;
        }

        /* Side panel actions */
        .side-panel-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        /* Transcript area in side panel */
        .component-transcript {
            margin-top: 15px;
        }

        .component-transcript textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
            resize: vertical;
        }

        .component-transcript textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        /* Component status indicator */
        .component-status {
            padding: 10px 12px;
            border-radius: var(--border-radius);
            margin-top: 12px;
            font-size: 0.9rem;
            display: none;
        }

        .component-status.show {
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tasks"></i> Paralegal Task Deconstruction Tool</h1>
            <p class="subtitle">Demonstrate how legal tasks can be broken down into automatable components. Enter a paralegal task to see its detailed breakdown and automation potential.</p>
        </header>

        <!-- Settings Panel -->
        <div class="settings-panel">
            <div class="settings-header" onclick="toggleSettings()">
                <h3><i class="fas fa-cog"></i> API Settings</h3>
                <i class="fas fa-chevron-down settings-toggle" id="settingsToggle"></i>
            </div>
            <div class="settings-content" id="settingsContent">
                <div class="settings-body">
                    <div class="settings-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Security Notice:</strong> API keys are stored in your browser's local storage.
                            Use dedicated API keys with spending limits. Clear keys when using shared computers.
                        </div>
                    </div>
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label for="openaiKey"><i class="fas fa-key"></i> OpenAI API Key</label>
                            <input type="password" id="openaiKey" placeholder="sk-..." autocomplete="off">
                            <small style="color: #666;">Required for audio transcription (Whisper) and optional for extraction (GPT-4)</small>
                        </div>
                        <div class="setting-group">
                            <label for="anthropicKey"><i class="fas fa-key"></i> Anthropic API Key</label>
                            <input type="password" id="anthropicKey" placeholder="sk-ant-..." autocomplete="off">
                            <small style="color: #666;">Optional - for extraction with Claude</small>
                        </div>
                        <div class="setting-group">
                            <label for="extractionModel"><i class="fas fa-brain"></i> Extraction AI</label>
                            <select id="extractionModel">
                                <option value="gpt-4o">OpenAI GPT-4o</option>
                                <option value="gpt-4o-mini">OpenAI GPT-4o-mini (faster)</option>
                                <option value="claude-sonnet">Claude 3.5 Sonnet</option>
                                <option value="claude-haiku">Claude 3.5 Haiku (faster)</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button class="btn btn-small btn-success" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="clearSettings()">
                            <i class="fas fa-trash"></i> Clear Keys
                        </button>
                    </div>
                    <div id="settingsStatus" class="status-message"></div>
                </div>
            </div>
        </div>

        <!-- Audio Intake Section -->
        <div class="audio-section">
            <div class="card">
                <h2><i class="fas fa-microphone-alt"></i> Audio Case Intake</h2>
                <p style="color: #666; margin-bottom: 20px;">Upload an audio file, record a voice note, or paste a transcript to extract case information.</p>

                <div class="audio-grid">
                    <!-- Left Column: Audio Input -->
                    <div>
                        <div class="audio-input-tabs">
                            <button class="audio-tab active" data-tab="upload" onclick="switchAudioTab('upload')">
                                <i class="fas fa-upload"></i> Upload
                            </button>
                            <button class="audio-tab" data-tab="record" onclick="switchAudioTab('record')">
                                <i class="fas fa-microphone"></i> Record
                            </button>
                            <button class="audio-tab" data-tab="paste" onclick="switchAudioTab('paste')">
                                <i class="fas fa-paste"></i> Paste
                            </button>
                        </div>

                        <!-- Upload Tab -->
                        <div class="audio-tab-content active" id="tab-upload">
                            <div class="file-drop-zone" id="dropZone" onclick="document.getElementById('audioFile').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Drag & drop audio file here or click to browse</p>
                                <span class="file-types">Supports: MP3, WAV, M4A, WebM, MP4 (max 25MB)</span>
                            </div>
                            <input type="file" id="audioFile" class="file-input" accept="audio/*,.mp3,.wav,.m4a,.webm,.mp4">
                            <div id="selectedFileDisplay" class="selected-file" style="display: none;">
                                <span><i class="fas fa-file-audio"></i> <span id="selectedFileName"></span></span>
                                <button class="remove-file" onclick="removeSelectedFile()"><i class="fas fa-times"></i></button>
                            </div>
                        </div>

                        <!-- Record Tab -->
                        <div class="audio-tab-content" id="tab-record">
                            <div class="recording-area">
                                <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
                                    <i class="fas fa-microphone" id="recordIcon"></i>
                                </button>
                                <p class="recording-status" id="recordingStatus">Click to start recording</p>
                                <p class="recording-time" id="recordingTime">00:00</p>
                                <p class="recording-hint">Maximum recording time: 5 minutes</p>
                            </div>
                        </div>

                        <!-- Paste Tab -->
                        <div class="audio-tab-content" id="tab-paste">
                            <textarea id="pasteTranscript" class="transcript-text" placeholder="Paste your transcript here (from Otter.ai, meeting notes, or any other source)..."></textarea>
                            <button class="btn btn-small" style="margin-top: 15px;" onclick="useTranscript(document.getElementById('pasteTranscript').value)">
                                <i class="fas fa-arrow-right"></i> Use This Transcript
                            </button>
                        </div>

                        <!-- Transcribe Button -->
                        <button class="btn btn-deconstruct" id="transcribeBtn" style="margin-top: 20px; width: 100%;" onclick="transcribeAudio()">
                            <i class="fas fa-language"></i> Transcribe Audio
                        </button>

                        <div id="audioStatus" class="status-message"></div>

                        <!-- Transcript Display -->
                        <div class="transcript-container" id="transcriptContainer" style="display: none;">
                            <div class="transcript-header">
                                <h4><i class="fas fa-file-alt"></i> Transcript</h4>
                                <button class="btn btn-small btn-success" onclick="extractCaseInfo()">
                                    <i class="fas fa-magic"></i> Extract Case Info
                                </button>
                            </div>
                            <textarea id="transcriptText" class="transcript-text" placeholder="Transcript will appear here..."></textarea>
                        </div>
                    </div>

                    <!-- Right Column: Case Intake Form -->
                    <div class="intake-form-container" id="intakeFormContainer">
                        <h3><i class="fas fa-clipboard-list"></i> Case Information</h3>

                        <!-- Client Information -->
                        <div class="intake-section">
                            <h4><i class="fas fa-user"></i> Client Information</h4>
                            <div class="intake-grid">
                                <div class="intake-field">
                                    <label>Full Name</label>
                                    <input type="text" id="clientName" placeholder="Enter client name">
                                </div>
                                <div class="intake-field">
                                    <label>Phone</label>
                                    <input type="tel" id="clientPhone" placeholder="(555) 555-5555">
                                </div>
                                <div class="intake-field">
                                    <label>Email</label>
                                    <input type="email" id="clientEmail" placeholder="client@email.com">
                                </div>
                                <div class="intake-field">
                                    <label>Date of Birth</label>
                                    <input type="date" id="clientDOB">
                                </div>
                                <div class="intake-field full-width">
                                    <label>Address</label>
                                    <input type="text" id="clientAddress" placeholder="Full address">
                                </div>
                            </div>
                        </div>

                        <!-- Case Details -->
                        <div class="intake-section">
                            <h4><i class="fas fa-gavel"></i> Case Details</h4>
                            <div class="intake-grid">
                                <div class="intake-field">
                                    <label>Case Type</label>
                                    <select id="caseType">
                                        <option value="">Select type...</option>
                                        <option value="personal-injury">Personal Injury</option>
                                        <option value="car-accident">Car Accident</option>
                                        <option value="medical-malpractice">Medical Malpractice</option>
                                        <option value="slip-fall">Slip and Fall</option>
                                        <option value="wrongful-death">Wrongful Death</option>
                                        <option value="employment">Employment</option>
                                        <option value="contract">Contract Dispute</option>
                                        <option value="family">Family Law</option>
                                        <option value="criminal">Criminal Defense</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="intake-field">
                                    <label>Incident Date</label>
                                    <input type="date" id="incidentDate">
                                </div>
                                <div class="intake-field">
                                    <label>Incident Location</label>
                                    <input type="text" id="incidentLocation" placeholder="City, State">
                                </div>
                                <div class="intake-field">
                                    <label>Jurisdiction</label>
                                    <input type="text" id="jurisdiction" placeholder="County/State">
                                </div>
                            </div>
                        </div>

                        <!-- Parties Involved -->
                        <div class="intake-section">
                            <h4><i class="fas fa-users"></i> Parties Involved</h4>
                            <div class="intake-grid">
                                <div class="intake-field full-width">
                                    <label>Defendants/Opposing Parties</label>
                                    <textarea id="defendants" placeholder="List all defendants or opposing parties..."></textarea>
                                </div>
                                <div class="intake-field full-width">
                                    <label>Witnesses</label>
                                    <textarea id="witnesses" placeholder="List any known witnesses with contact info if available..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Facts & Narrative -->
                        <div class="intake-section">
                            <h4><i class="fas fa-book"></i> Case Facts</h4>
                            <div class="intake-grid">
                                <div class="intake-field full-width">
                                    <label>Narrative Summary</label>
                                    <textarea id="narrativeSummary" placeholder="Chronological summary of events..." style="min-height: 120px;"></textarea>
                                </div>
                                <div class="intake-field full-width">
                                    <label>Key Events</label>
                                    <textarea id="keyEvents" placeholder="List key events and dates..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Damages -->
                        <div class="intake-section">
                            <h4><i class="fas fa-notes-medical"></i> Damages</h4>
                            <div class="intake-grid">
                                <div class="intake-field full-width">
                                    <label>Physical Injuries</label>
                                    <textarea id="physicalInjuries" placeholder="Describe any physical injuries..."></textarea>
                                </div>
                                <div class="intake-field">
                                    <label>Property Damage</label>
                                    <input type="text" id="propertyDamage" placeholder="Describe property damage">
                                </div>
                                <div class="intake-field">
                                    <label>Financial Losses</label>
                                    <input type="text" id="financialLosses" placeholder="Lost wages, medical bills, etc.">
                                </div>
                            </div>
                        </div>

                        <!-- Evidence & Urgency -->
                        <div class="intake-section">
                            <h4><i class="fas fa-folder-open"></i> Evidence & Urgency</h4>
                            <div class="intake-grid">
                                <div class="intake-field full-width">
                                    <label>Available Evidence</label>
                                    <textarea id="availableEvidence" placeholder="List any documents, photos, records mentioned..."></textarea>
                                </div>
                                <div class="intake-field full-width">
                                    <label>Urgency / Statute of Limitations Concerns</label>
                                    <textarea id="urgencyNotes" placeholder="Any time-sensitive matters or deadlines..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="intake-actions">
                            <button class="btn btn-small" onclick="copyIntakeToClipboard()">
                                <i class="fas fa-copy"></i> Copy to Clipboard
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="downloadIntakeJSON()">
                                <i class="fas fa-download"></i> Download JSON
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="clearIntakeForm()">
                                <i class="fas fa-eraser"></i> Clear Form
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Overlay -->
        <div class="processing-overlay" id="processingOverlay">
            <div class="processing-modal">
                <div class="loading-spinner"></div>
                <h3 id="processingTitle">Processing...</h3>
                <p id="processingMessage">Please wait while we process your request.</p>
            </div>
        </div>
        
        <div class="main-content">
            <div class="card">
                <h2><i class="fas fa-keyboard"></i> Enter Paralegal Task</h2>
                <div class="input-area">
                    <div class="task-input-container">
                        <label for="taskInput">Describe a paralegal task you'd like to deconstruct:</label>
                        <textarea id="taskInput" placeholder="Example: Draft a complaint for a civil lawsuit..."></textarea>
                    </div>
                    
                    <div class="examples">
                        <h3>Try these example tasks:</h3>
                        <div class="example-list">
                            <button class="example-btn" data-example="Draft a complaint for a civil lawsuit">Draft Complaint</button>
                            <button class="example-btn" data-example="Conduct document review for discovery">Document Review</button>
                            <button class="example-btn" data-example="Prepare deposition summaries">Deposition Summaries</button>
                            <button class="example-btn" data-example="File court documents electronically">E-Filing</button>
                            <button class="example-btn" data-example="Prepare trial exhibit binders">Trial Exhibits</button>
                        </div>
                    </div>
                    
                    <button id="deconstructBtn" class="btn btn-deconstruct">
                        <i class="fas fa-cogs"></i> Deconstruct Task
                    </button>
                </div>
                
                <div class="instructions">
                    <h3><i class="fas fa-info-circle"></i> How It Works</h3>
                    <p>This tool demonstrates how complex paralegal tasks can be broken down into smaller, manageable components. Each component is analyzed for automation potential, showing how legal technology can streamline paralegal work.</p>
                </div>
            </div>
            
            <div class="card results-area">
                <h2><i class="fas fa-project-diagram"></i> Task Breakdown</h2>
                
                <div class="loading" id="loadingIndicator">
                    <div class="loading-spinner"></div>
                    <p>Analyzing task components...</p>
                </div>
                
                <div id="resultsContainer">
                    <div class="task-display" id="taskDisplay">
                        <p><strong>Your Task:</strong> <span id="currentTask">Enter a task above to see the breakdown</span></p>
                    </div>
                    
                    <div class="breakdown-container" id="breakdownContainer">
                        <p class="instructions">The task breakdown will appear here after you click "Deconstruct Task".</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="automation-analysis" id="automationAnalysis" style="display: none;">
            <h2><i class="fas fa-robot"></i> Automation Analysis</h2>
            <p>Based on the task breakdown, here's how automation could be implemented:</p>
            
            <div class="analysis-grid" id="analysisGrid">
                <!-- Analysis cards will be inserted here -->
            </div>
        </div>
        
        <footer>
            <p>Paralegal Task Deconstruction Tool | Designed to demonstrate task analysis for automation potential</p>
            <p>This tool is for demonstration purposes and does not constitute legal advice.</p>
        </footer>
    </div>

    <!-- Component Side Panel -->
    <div class="side-panel-overlay" id="sidePanelOverlay" onclick="closeSidePanel()"></div>
    <div class="side-panel" id="sidePanel">
        <div class="side-panel-header">
            <h3 id="sidePanelTitle">Component Details</h3>
            <button class="side-panel-close" onclick="closeSidePanel()">&times;</button>
        </div>
        <div class="side-panel-body">
            <!-- Audio Input Section -->
            <div class="side-panel-section">
                <h4><i class="fas fa-microphone-alt"></i> Audio Input</h4>

                <div class="component-audio-tabs">
                    <button class="component-audio-tab active" data-ctab="upload" onclick="switchComponentTab('upload')">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                    <button class="component-audio-tab" data-ctab="record" onclick="switchComponentTab('record')">
                        <i class="fas fa-microphone"></i> Record
                    </button>
                    <button class="component-audio-tab" data-ctab="paste" onclick="switchComponentTab('paste')">
                        <i class="fas fa-paste"></i> Paste
                    </button>
                </div>

                <!-- Upload Tab -->
                <div class="component-tab-content active" id="ctab-upload">
                    <div class="compact-drop-zone" id="componentDropZone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drop audio file or click to browse</p>
                    </div>
                    <input type="file" id="componentAudioFile" class="file-input" accept="audio/*,.mp3,.wav,.m4a,.webm,.mp4">
                    <div id="componentSelectedFile" class="selected-file" style="display: none;">
                        <span><i class="fas fa-file-audio"></i> <span id="componentFileName"></span></span>
                        <button class="remove-file" onclick="removeComponentFile()"><i class="fas fa-times"></i></button>
                    </div>
                </div>

                <!-- Record Tab -->
                <div class="component-tab-content" id="ctab-record">
                    <div class="compact-recording">
                        <button class="compact-record-btn" id="componentRecordBtn" onclick="toggleComponentRecording()">
                            <i class="fas fa-microphone" id="componentRecordIcon"></i>
                        </button>
                        <p id="componentRecordingStatus">Click to record</p>
                        <p class="recording-time" id="componentRecordingTime">00:00</p>
                    </div>
                </div>

                <!-- Paste Tab -->
                <div class="component-tab-content" id="ctab-paste">
                    <textarea id="componentPasteTranscript" class="transcript-text" style="min-height: 100px;" placeholder="Paste your transcript here..."></textarea>
                    <button class="btn btn-small" style="margin-top: 10px;" onclick="useComponentTranscript()">
                        <i class="fas fa-arrow-right"></i> Use Transcript
                    </button>
                </div>

                <!-- Transcribe Button -->
                <button class="btn btn-deconstruct" style="margin-top: 15px; width: 100%;" onclick="transcribeComponentAudio()">
                    <i class="fas fa-language"></i> Transcribe Audio
                </button>

                <div id="componentStatus" class="component-status"></div>

                <!-- Transcript Display -->
                <div class="component-transcript" id="componentTranscriptArea" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label style="font-weight: 600; color: var(--primary-color);">Transcript</label>
                        <button class="btn btn-small btn-success" onclick="extractComponentInfo()">
                            <i class="fas fa-magic"></i> Extract Info
                        </button>
                    </div>
                    <textarea id="componentTranscriptText" placeholder="Transcript will appear here..."></textarea>
                </div>
            </div>

            <!-- Dynamic Form Section -->
            <div class="side-panel-section">
                <h4><i class="fas fa-clipboard-list"></i> <span id="componentFormTitle">Extracted Information</span></h4>
                <div id="componentFormContainer">
                    <!-- Form fields will be dynamically inserted here -->
                </div>
                <div class="side-panel-actions">
                    <button class="btn btn-small btn-success" onclick="saveComponentData()">
                        <i class="fas fa-save"></i> Save
                    </button>
                    <button class="btn btn-small" onclick="copyComponentData()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="btn btn-small btn-secondary" onclick="clearComponentForm()">
                        <i class="fas fa-eraser"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // AUDIO INTAKE & SETTINGS FUNCTIONALITY
        // ============================================

        // Global state for audio recording
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingTimer = null;
        let recordingSeconds = 0;
        let selectedAudioFile = null;
        let recordedAudioBlob = null;

        // Settings Management
        function toggleSettings() {
            const content = document.getElementById('settingsContent');
            const toggle = document.getElementById('settingsToggle');
            content.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        function saveSettings() {
            const openaiKey = document.getElementById('openaiKey').value.trim();
            const anthropicKey = document.getElementById('anthropicKey').value.trim();
            const extractionModel = document.getElementById('extractionModel').value;

            localStorage.setItem('paralegal_openai_key', openaiKey);
            localStorage.setItem('paralegal_anthropic_key', anthropicKey);
            localStorage.setItem('paralegal_extraction_model', extractionModel);

            showStatus('settingsStatus', 'Settings saved successfully!', 'success');
        }

        function loadSettings() {
            const openaiKey = localStorage.getItem('paralegal_openai_key') || '';
            const anthropicKey = localStorage.getItem('paralegal_anthropic_key') || '';
            const extractionModel = localStorage.getItem('paralegal_extraction_model') || 'gpt-4o';

            document.getElementById('openaiKey').value = openaiKey;
            document.getElementById('anthropicKey').value = anthropicKey;
            document.getElementById('extractionModel').value = extractionModel;

            // If keys exist, show a visual indicator
            if (openaiKey || anthropicKey) {
                document.getElementById('settingsContent').classList.add('open');
                document.getElementById('settingsToggle').classList.add('open');
            }
        }

        function clearSettings() {
            if (confirm('Are you sure you want to clear all API keys?')) {
                localStorage.removeItem('paralegal_openai_key');
                localStorage.removeItem('paralegal_anthropic_key');
                document.getElementById('openaiKey').value = '';
                document.getElementById('anthropicKey').value = '';
                showStatus('settingsStatus', 'API keys cleared.', 'info');
            }
        }

        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${message}`;
            statusEl.className = `status-message show ${type}`;
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 5000);
        }

        // Audio Tab Switching
        function switchAudioTab(tabName) {
            document.querySelectorAll('.audio-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.audio-tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // File Upload Handling
        function setupFileUpload() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('audioFile');

            // Drag and drop events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'));
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'));
            });

            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        function handleFileSelect(file) {
            const maxSize = 25 * 1024 * 1024; // 25MB
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/mp4', 'audio/m4a', 'audio/webm', 'video/mp4', 'video/webm'];

            if (file.size > maxSize) {
                showStatus('audioStatus', 'File is too large. Maximum size is 25MB.', 'error');
                return;
            }

            selectedAudioFile = file;
            recordedAudioBlob = null; // Clear any recorded audio

            document.getElementById('selectedFileName').textContent = file.name;
            document.getElementById('selectedFileDisplay').style.display = 'flex';
            document.getElementById('dropZone').style.display = 'none';
        }

        function removeSelectedFile() {
            selectedAudioFile = null;
            document.getElementById('audioFile').value = '';
            document.getElementById('selectedFileDisplay').style.display = 'none';
            document.getElementById('dropZone').style.display = 'block';
        }

        // Voice Recording
        async function toggleRecording() {
            const recordBtn = document.getElementById('recordBtn');
            const recordIcon = document.getElementById('recordIcon');
            const recordingStatus = document.getElementById('recordingStatus');

            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // Stop recording
                mediaRecorder.stop();
                recordBtn.classList.remove('recording');
                recordIcon.className = 'fas fa-microphone';
                recordingStatus.textContent = 'Recording saved';
                clearInterval(recordingTimer);
            } else {
                // Start recording
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (e) => {
                        audioChunks.push(e.data);
                    };

                    mediaRecorder.onstop = () => {
                        recordedAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        selectedAudioFile = null; // Clear any uploaded file
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    recordBtn.classList.add('recording');
                    recordIcon.className = 'fas fa-stop';
                    recordingStatus.textContent = 'Recording...';
                    recordingSeconds = 0;
                    updateRecordingTime();

                    recordingTimer = setInterval(() => {
                        recordingSeconds++;
                        updateRecordingTime();
                        // Auto-stop at 5 minutes
                        if (recordingSeconds >= 300) {
                            toggleRecording();
                        }
                    }, 1000);
                } catch (err) {
                    showStatus('audioStatus', 'Could not access microphone. Please check permissions.', 'error');
                }
            }
        }

        function updateRecordingTime() {
            const minutes = Math.floor(recordingSeconds / 60);
            const seconds = recordingSeconds % 60;
            document.getElementById('recordingTime').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Transcription
        async function transcribeAudio() {
            const openaiKey = localStorage.getItem('paralegal_openai_key');

            if (!openaiKey) {
                showStatus('audioStatus', 'Please add your OpenAI API key in Settings.', 'error');
                toggleSettings();
                return;
            }

            let audioToTranscribe = selectedAudioFile || recordedAudioBlob;

            if (!audioToTranscribe) {
                showStatus('audioStatus', 'Please upload an audio file or record a voice note first.', 'error');
                return;
            }

            showProcessing('Transcribing Audio', 'Converting speech to text using OpenAI Whisper...');

            try {
                const formData = new FormData();
                formData.append('file', audioToTranscribe, audioToTranscribe.name || 'recording.webm');
                formData.append('model', 'whisper-1');

                const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${openaiKey}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Transcription failed');
                }

                const result = await response.json();
                useTranscript(result.text);
                hideProcessing();
                showStatus('audioStatus', 'Transcription complete!', 'success');
            } catch (err) {
                hideProcessing();
                showStatus('audioStatus', `Error: ${err.message}`, 'error');
            }
        }

        function useTranscript(text) {
            if (!text || !text.trim()) {
                showStatus('audioStatus', 'No transcript text provided.', 'error');
                return;
            }

            document.getElementById('transcriptText').value = text;
            document.getElementById('transcriptContainer').style.display = 'block';
        }

        // AI Extraction
        async function extractCaseInfo() {
            const transcript = document.getElementById('transcriptText').value.trim();

            if (!transcript) {
                showStatus('audioStatus', 'No transcript to extract from.', 'error');
                return;
            }

            const extractionModel = localStorage.getItem('paralegal_extraction_model') || 'gpt-4o';
            const isClaudeModel = extractionModel.startsWith('claude');

            const apiKey = isClaudeModel
                ? localStorage.getItem('paralegal_anthropic_key')
                : localStorage.getItem('paralegal_openai_key');

            if (!apiKey) {
                const provider = isClaudeModel ? 'Anthropic' : 'OpenAI';
                showStatus('audioStatus', `Please add your ${provider} API key in Settings.`, 'error');
                toggleSettings();
                return;
            }

            showProcessing('Extracting Case Information', `Analyzing transcript with ${extractionModel}...`);

            const extractionPrompt = `You are a legal intake specialist. Analyze the following transcript from a client consultation and extract all relevant case information.

Return your response as a JSON object with exactly these fields (use empty string if information is not available):

{
    "clientName": "Full name of the client",
    "clientPhone": "Phone number",
    "clientEmail": "Email address",
    "clientDOB": "Date of birth in YYYY-MM-DD format",
    "clientAddress": "Full address",
    "caseType": "One of: personal-injury, car-accident, medical-malpractice, slip-fall, wrongful-death, employment, contract, family, criminal, other",
    "incidentDate": "Date of incident in YYYY-MM-DD format",
    "incidentLocation": "City, State where incident occurred",
    "jurisdiction": "County/State for jurisdiction",
    "defendants": "Names and descriptions of defendants or opposing parties",
    "witnesses": "Names and contact info of any witnesses mentioned",
    "narrativeSummary": "A chronological summary of what happened",
    "keyEvents": "Bullet points of key events with dates",
    "physicalInjuries": "Description of physical injuries",
    "propertyDamage": "Description of property damage",
    "financialLosses": "Lost wages, medical bills, other financial losses",
    "availableEvidence": "Documents, photos, records mentioned",
    "urgencyNotes": "Any statute of limitations concerns or urgent matters"
}

TRANSCRIPT:
${transcript}

Respond with ONLY the JSON object, no additional text.`;

            try {
                let result;

                if (isClaudeModel) {
                    const modelId = extractionModel === 'claude-sonnet' ? 'claude-sonnet-4-20250514' : 'claude-3-5-haiku-20241022';

                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: modelId,
                            max_tokens: 4096,
                            messages: [{
                                role: 'user',
                                content: extractionPrompt
                            }]
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'Extraction failed');
                    }

                    const data = await response.json();
                    result = JSON.parse(data.content[0].text);
                } else {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: extractionModel,
                            messages: [{
                                role: 'user',
                                content: extractionPrompt
                            }],
                            response_format: { type: 'json_object' }
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'Extraction failed');
                    }

                    const data = await response.json();
                    result = JSON.parse(data.choices[0].message.content);
                }

                populateIntakeForm(result);
                hideProcessing();
                showStatus('audioStatus', 'Case information extracted successfully!', 'success');
            } catch (err) {
                hideProcessing();
                showStatus('audioStatus', `Extraction error: ${err.message}`, 'error');
            }
        }

        function populateIntakeForm(data) {
            const fieldMappings = {
                clientName: 'clientName',
                clientPhone: 'clientPhone',
                clientEmail: 'clientEmail',
                clientDOB: 'clientDOB',
                clientAddress: 'clientAddress',
                caseType: 'caseType',
                incidentDate: 'incidentDate',
                incidentLocation: 'incidentLocation',
                jurisdiction: 'jurisdiction',
                defendants: 'defendants',
                witnesses: 'witnesses',
                narrativeSummary: 'narrativeSummary',
                keyEvents: 'keyEvents',
                physicalInjuries: 'physicalInjuries',
                propertyDamage: 'propertyDamage',
                financialLosses: 'financialLosses',
                availableEvidence: 'availableEvidence',
                urgencyNotes: 'urgencyNotes'
            };

            for (const [dataKey, elementId] of Object.entries(fieldMappings)) {
                const element = document.getElementById(elementId);
                if (element && data[dataKey]) {
                    element.value = data[dataKey];
                }
            }
        }

        // Form Actions
        function getIntakeFormData() {
            return {
                client: {
                    name: document.getElementById('clientName').value,
                    phone: document.getElementById('clientPhone').value,
                    email: document.getElementById('clientEmail').value,
                    dob: document.getElementById('clientDOB').value,
                    address: document.getElementById('clientAddress').value
                },
                case: {
                    type: document.getElementById('caseType').value,
                    incidentDate: document.getElementById('incidentDate').value,
                    incidentLocation: document.getElementById('incidentLocation').value,
                    jurisdiction: document.getElementById('jurisdiction').value
                },
                parties: {
                    defendants: document.getElementById('defendants').value,
                    witnesses: document.getElementById('witnesses').value
                },
                facts: {
                    narrative: document.getElementById('narrativeSummary').value,
                    keyEvents: document.getElementById('keyEvents').value
                },
                damages: {
                    physicalInjuries: document.getElementById('physicalInjuries').value,
                    propertyDamage: document.getElementById('propertyDamage').value,
                    financialLosses: document.getElementById('financialLosses').value
                },
                evidence: {
                    available: document.getElementById('availableEvidence').value,
                    urgency: document.getElementById('urgencyNotes').value
                },
                extractedAt: new Date().toISOString()
            };
        }

        function copyIntakeToClipboard() {
            const data = getIntakeFormData();
            const text = formatIntakeAsText(data);

            navigator.clipboard.writeText(text).then(() => {
                showStatus('audioStatus', 'Case information copied to clipboard!', 'success');
            }).catch(() => {
                showStatus('audioStatus', 'Failed to copy to clipboard.', 'error');
            });
        }

        function formatIntakeAsText(data) {
            return `CASE INTAKE INFORMATION
========================

CLIENT INFORMATION
------------------
Name: ${data.client.name}
Phone: ${data.client.phone}
Email: ${data.client.email}
Date of Birth: ${data.client.dob}
Address: ${data.client.address}

CASE DETAILS
------------
Case Type: ${data.case.type}
Incident Date: ${data.case.incidentDate}
Incident Location: ${data.case.incidentLocation}
Jurisdiction: ${data.case.jurisdiction}

PARTIES INVOLVED
----------------
Defendants/Opposing Parties:
${data.parties.defendants}

Witnesses:
${data.parties.witnesses}

CASE FACTS
----------
Narrative Summary:
${data.facts.narrative}

Key Events:
${data.facts.keyEvents}

DAMAGES
-------
Physical Injuries:
${data.damages.physicalInjuries}

Property Damage: ${data.damages.propertyDamage}
Financial Losses: ${data.damages.financialLosses}

EVIDENCE & URGENCY
------------------
Available Evidence:
${data.evidence.available}

Urgency Notes:
${data.evidence.urgency}

---
Extracted: ${new Date(data.extractedAt).toLocaleString()}`;
        }

        function downloadIntakeJSON() {
            const data = getIntakeFormData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `case-intake-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearIntakeForm() {
            if (confirm('Are you sure you want to clear all form fields?')) {
                const fields = ['clientName', 'clientPhone', 'clientEmail', 'clientDOB', 'clientAddress',
                    'caseType', 'incidentDate', 'incidentLocation', 'jurisdiction',
                    'defendants', 'witnesses', 'narrativeSummary', 'keyEvents',
                    'physicalInjuries', 'propertyDamage', 'financialLosses',
                    'availableEvidence', 'urgencyNotes'];

                fields.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
            }
        }

        // Processing Overlay
        function showProcessing(title, message) {
            document.getElementById('processingTitle').textContent = title;
            document.getElementById('processingMessage').textContent = message;
            document.getElementById('processingOverlay').classList.add('active');
        }

        function hideProcessing() {
            document.getElementById('processingOverlay').classList.remove('active');
        }

        // Initialize audio functionality
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            setupFileUpload();
            setupComponentFileUpload();
        });

        // ============================================
        // COMPONENT SIDE PANEL FUNCTIONALITY
        // ============================================

        // Component state
        let currentComponent = null;
        let componentAudioFile = null;
        let componentRecordedBlob = null;
        let componentMediaRecorder = null;
        let componentRecordingTimer = null;
        let componentRecordingSeconds = 0;
        let componentDataStore = {}; // Store data for each component

        // Component form definitions - each component has its own form structure
        const componentForms = {
            "Review case facts and client information": {
                title: "Case Facts & Client Information",
                icon: "fas fa-user-tie",
                fields: [
                    { id: "clientFullName", label: "Client Full Name", type: "text", fullWidth: false },
                    { id: "clientContact", label: "Contact Information", type: "text", fullWidth: false },
                    { id: "caseBackground", label: "Case Background", type: "textarea", fullWidth: true },
                    { id: "keyFacts", label: "Key Facts", type: "textarea", fullWidth: true },
                    { id: "relevantDates", label: "Relevant Dates", type: "textarea", fullWidth: true },
                    { id: "documentsSources", label: "Documents & Sources Reviewed", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract case facts and client information from this transcript. Return JSON with:
                    {"clientFullName": "", "clientContact": "", "caseBackground": "", "keyFacts": "", "relevantDates": "", "documentsSources": ""}`
            },
            "Identify proper jurisdiction and venue": {
                title: "Jurisdiction & Venue Analysis",
                icon: "fas fa-map-marker-alt",
                fields: [
                    { id: "stateJurisdiction", label: "State Jurisdiction", type: "text", fullWidth: false },
                    { id: "federalQuestion", label: "Federal Question (if any)", type: "text", fullWidth: false },
                    { id: "diversityJurisdiction", label: "Diversity Jurisdiction", type: "text", fullWidth: false },
                    { id: "amountInControversy", label: "Amount in Controversy", type: "text", fullWidth: false },
                    { id: "properVenue", label: "Proper Venue", type: "text", fullWidth: true },
                    { id: "venueFactors", label: "Venue Factors", type: "textarea", fullWidth: true },
                    { id: "jurisdictionNotes", label: "Jurisdiction Analysis Notes", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Analyze jurisdiction and venue from this transcript. Return JSON with:
                    {"stateJurisdiction": "", "federalQuestion": "", "diversityJurisdiction": "", "amountInControversy": "", "properVenue": "", "venueFactors": "", "jurisdictionNotes": ""}`
            },
            "Determine causes of action": {
                title: "Causes of Action",
                icon: "fas fa-balance-scale",
                fields: [
                    { id: "primaryClaim", label: "Primary Claim/Cause of Action", type: "text", fullWidth: true },
                    { id: "additionalClaims", label: "Additional Claims", type: "textarea", fullWidth: true },
                    { id: "elementsAnalysis", label: "Elements Analysis", type: "textarea", fullWidth: true },
                    { id: "factsSupporting", label: "Facts Supporting Each Element", type: "textarea", fullWidth: true },
                    { id: "potentialDefenses", label: "Potential Defenses to Consider", type: "textarea", fullWidth: true },
                    { id: "damagesAvailable", label: "Damages Available", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Identify causes of action from this transcript. Return JSON with:
                    {"primaryClaim": "", "additionalClaims": "", "elementsAnalysis": "", "factsSupporting": "", "potentialDefenses": "", "damagesAvailable": ""}`
            },
            "Research applicable laws and precedents": {
                title: "Legal Research",
                icon: "fas fa-search",
                fields: [
                    { id: "applicableStatutes", label: "Applicable Statutes", type: "textarea", fullWidth: true },
                    { id: "relevantCaseLaw", label: "Relevant Case Law", type: "textarea", fullWidth: true },
                    { id: "keyHoldings", label: "Key Holdings", type: "textarea", fullWidth: true },
                    { id: "statuteOfLimitations", label: "Statute of Limitations", type: "text", fullWidth: false },
                    { id: "standardOfProof", label: "Standard of Proof", type: "text", fullWidth: false },
                    { id: "researchNotes", label: "Research Notes", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract legal research information from this transcript. Return JSON with:
                    {"applicableStatutes": "", "relevantCaseLaw": "", "keyHoldings": "", "statuteOfLimitations": "", "standardOfProof": "", "researchNotes": ""}`
            },
            "Draft caption and parties section": {
                title: "Caption & Parties",
                icon: "fas fa-heading",
                fields: [
                    { id: "courtName", label: "Court Name", type: "text", fullWidth: true },
                    { id: "plaintiffNames", label: "Plaintiff Name(s)", type: "textarea", fullWidth: true },
                    { id: "plaintiffCapacity", label: "Plaintiff Capacity/Status", type: "text", fullWidth: true },
                    { id: "defendantNames", label: "Defendant Name(s)", type: "textarea", fullWidth: true },
                    { id: "defendantCapacity", label: "Defendant Capacity/Status", type: "text", fullWidth: true },
                    { id: "caseNumber", label: "Case Number (if known)", type: "text", fullWidth: false },
                    { id: "documentTitle", label: "Document Title", type: "text", fullWidth: false }
                ],
                extractionPrompt: `Extract caption and parties information from this transcript. Return JSON with:
                    {"courtName": "", "plaintiffNames": "", "plaintiffCapacity": "", "defendantNames": "", "defendantCapacity": "", "caseNumber": "", "documentTitle": ""}`
            },
            "Write factual allegations": {
                title: "Factual Allegations",
                icon: "fas fa-file-alt",
                fields: [
                    { id: "partiesAllegations", label: "Parties Allegations", type: "textarea", fullWidth: true },
                    { id: "jurisdictionAllegations", label: "Jurisdictional Allegations", type: "textarea", fullWidth: true },
                    { id: "factualBackground", label: "Factual Background (chronological)", type: "textarea", fullWidth: true },
                    { id: "specificIncidents", label: "Specific Incidents/Events", type: "textarea", fullWidth: true },
                    { id: "injuriesHarms", label: "Injuries/Harms Suffered", type: "textarea", fullWidth: true },
                    { id: "causation", label: "Causation Statements", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract factual allegations from this transcript. Return JSON with:
                    {"partiesAllegations": "", "jurisdictionAllegations": "", "factualBackground": "", "specificIncidents": "", "injuriesHarms": "", "causation": ""}`
            },
            "Formulate legal claims": {
                title: "Legal Claims",
                icon: "fas fa-gavel",
                fields: [
                    { id: "countOne", label: "Count I - Claim & Elements", type: "textarea", fullWidth: true },
                    { id: "countTwo", label: "Count II - Claim & Elements", type: "textarea", fullWidth: true },
                    { id: "countThree", label: "Count III - Claim & Elements", type: "textarea", fullWidth: true },
                    { id: "additionalCounts", label: "Additional Counts", type: "textarea", fullWidth: true },
                    { id: "incorporatedAllegations", label: "Incorporated Allegations", type: "textarea", fullWidth: true },
                    { id: "legalStandards", label: "Legal Standards Applied", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract legal claims from this transcript. Return JSON with:
                    {"countOne": "", "countTwo": "", "countThree": "", "additionalCounts": "", "incorporatedAllegations": "", "legalStandards": ""}`
            },
            "Draft prayer for relief": {
                title: "Prayer for Relief",
                icon: "fas fa-pray",
                fields: [
                    { id: "compensatoryDamages", label: "Compensatory Damages", type: "textarea", fullWidth: true },
                    { id: "punitiveDamages", label: "Punitive Damages", type: "textarea", fullWidth: true },
                    { id: "injunctiveRelief", label: "Injunctive Relief", type: "textarea", fullWidth: true },
                    { id: "declaratoryRelief", label: "Declaratory Relief", type: "textarea", fullWidth: true },
                    { id: "attorneyFees", label: "Attorney Fees & Costs", type: "text", fullWidth: true },
                    { id: "otherRelief", label: "Other Relief Requested", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract prayer for relief information from this transcript. Return JSON with:
                    {"compensatoryDamages": "", "punitiveDamages": "", "injunctiveRelief": "", "declaratoryRelief": "", "attorneyFees": "", "otherRelief": ""}`
            },
            "Include verification if required": {
                title: "Verification",
                icon: "fas fa-check-circle",
                fields: [
                    { id: "verificationRequired", label: "Verification Required?", type: "select", options: ["Yes", "No", "Unknown"], fullWidth: false },
                    { id: "verificationBasis", label: "Basis for Verification Requirement", type: "text", fullWidth: false },
                    { id: "verifyingParty", label: "Verifying Party", type: "text", fullWidth: false },
                    { id: "verificationCapacity", label: "Capacity of Verifying Party", type: "text", fullWidth: false },
                    { id: "verificationLanguage", label: "Verification Language", type: "textarea", fullWidth: true },
                    { id: "notaryRequired", label: "Notarization Required?", type: "select", options: ["Yes", "No"], fullWidth: false }
                ],
                extractionPrompt: `Extract verification requirements from this transcript. Return JSON with:
                    {"verificationRequired": "", "verificationBasis": "", "verifyingParty": "", "verificationCapacity": "", "verificationLanguage": "", "notaryRequired": ""}`
            },
            "Format according to court rules": {
                title: "Court Formatting Rules",
                icon: "fas fa-ruler",
                fields: [
                    { id: "courtRulesReference", label: "Applicable Court Rules", type: "text", fullWidth: true },
                    { id: "fontRequirements", label: "Font Requirements", type: "text", fullWidth: false },
                    { id: "marginRequirements", label: "Margin Requirements", type: "text", fullWidth: false },
                    { id: "lineSpacing", label: "Line Spacing", type: "text", fullWidth: false },
                    { id: "pageLimits", label: "Page Limits", type: "text", fullWidth: false },
                    { id: "filingRequirements", label: "Filing Requirements", type: "textarea", fullWidth: true },
                    { id: "serviceRequirements", label: "Service Requirements", type: "textarea", fullWidth: true },
                    { id: "localRulesNotes", label: "Local Rules Notes", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract court formatting rules from this transcript. Return JSON with:
                    {"courtRulesReference": "", "fontRequirements": "", "marginRequirements": "", "lineSpacing": "", "pageLimits": "", "filingRequirements": "", "serviceRequirements": "", "localRulesNotes": ""}`
            },
            // Document Review Components
            "Receive document production from opposing party": {
                title: "Document Production Receipt",
                icon: "fas fa-inbox",
                fields: [
                    { id: "productionDate", label: "Date Received", type: "text", fullWidth: false },
                    { id: "producingParty", label: "Producing Party", type: "text", fullWidth: false },
                    { id: "volumeOfDocs", label: "Volume (# of documents/pages)", type: "text", fullWidth: false },
                    { id: "formatReceived", label: "Format Received", type: "text", fullWidth: false },
                    { id: "batesRange", label: "Bates Range", type: "text", fullWidth: true },
                    { id: "initialAssessment", label: "Initial Assessment Notes", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract document production information from this transcript. Return JSON with:
                    {"productionDate": "", "producingParty": "", "volumeOfDocs": "", "formatReceived": "", "batesRange": "", "initialAssessment": ""}`
            },
            "Organize documents by source and date": {
                title: "Document Organization",
                icon: "fas fa-folder-open",
                fields: [
                    { id: "organizationMethod", label: "Organization Method", type: "text", fullWidth: true },
                    { id: "sourceCategories", label: "Source Categories", type: "textarea", fullWidth: true },
                    { id: "dateRanges", label: "Date Ranges", type: "textarea", fullWidth: true },
                    { id: "folderStructure", label: "Folder Structure", type: "textarea", fullWidth: true },
                    { id: "namingConvention", label: "Naming Convention", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract document organization details from this transcript. Return JSON with:
                    {"organizationMethod": "", "sourceCategories": "", "dateRanges": "", "folderStructure": "", "namingConvention": ""}`
            },
            "Apply relevance criteria to filter documents": {
                title: "Relevance Criteria",
                icon: "fas fa-filter",
                fields: [
                    { id: "relevanceCriteria", label: "Relevance Criteria", type: "textarea", fullWidth: true },
                    { id: "keySearchTerms", label: "Key Search Terms", type: "textarea", fullWidth: true },
                    { id: "dateFilters", label: "Date Filters", type: "text", fullWidth: true },
                    { id: "custodianFilters", label: "Custodian Filters", type: "textarea", fullWidth: true },
                    { id: "responsiveCount", label: "Responsive Count", type: "text", fullWidth: false },
                    { id: "nonResponsiveCount", label: "Non-Responsive Count", type: "text", fullWidth: false }
                ],
                extractionPrompt: `Extract relevance criteria from this transcript. Return JSON with:
                    {"relevanceCriteria": "", "keySearchTerms": "", "dateFilters": "", "custodianFilters": "", "responsiveCount": "", "nonResponsiveCount": ""}`
            },
            "Identify privileged materials": {
                title: "Privilege Review",
                icon: "fas fa-shield-alt",
                fields: [
                    { id: "privilegeTypes", label: "Privilege Types Identified", type: "textarea", fullWidth: true },
                    { id: "privilegedDocs", label: "Privileged Documents", type: "textarea", fullWidth: true },
                    { id: "privilegeHolders", label: "Privilege Holders", type: "textarea", fullWidth: true },
                    { id: "waiverConcerns", label: "Waiver Concerns", type: "textarea", fullWidth: true },
                    { id: "privilegeLogNotes", label: "Privilege Log Notes", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract privilege review information from this transcript. Return JSON with:
                    {"privilegeTypes": "", "privilegedDocs": "", "privilegeHolders": "", "waiverConcerns": "", "privilegeLogNotes": ""}`
            },
            "Flag key documents for case strategy": {
                title: "Key Documents",
                icon: "fas fa-star",
                fields: [
                    { id: "hotDocuments", label: "Hot Documents", type: "textarea", fullWidth: true },
                    { id: "supportingDocs", label: "Supporting Documents", type: "textarea", fullWidth: true },
                    { id: "damagingDocs", label: "Potentially Damaging Documents", type: "textarea", fullWidth: true },
                    { id: "strategicNotes", label: "Strategic Notes", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract key document information from this transcript. Return JSON with:
                    {"hotDocuments": "", "supportingDocs": "", "damagingDocs": "", "strategicNotes": ""}`
            },
            "Code documents for easy retrieval": {
                title: "Document Coding",
                icon: "fas fa-tags",
                fields: [
                    { id: "issueTags", label: "Issue Tags", type: "textarea", fullWidth: true },
                    { id: "witnessConnections", label: "Witness Connections", type: "textarea", fullWidth: true },
                    { id: "dateCategories", label: "Date Categories", type: "textarea", fullWidth: true },
                    { id: "documentTypes", label: "Document Types", type: "textarea", fullWidth: true },
                    { id: "codingNotes", label: "Coding Notes", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract document coding information from this transcript. Return JSON with:
                    {"issueTags": "", "witnessConnections": "", "dateCategories": "", "documentTypes": "", "codingNotes": ""}`
            },
            "Prepare document summaries": {
                title: "Document Summaries",
                icon: "fas fa-file-contract",
                fields: [
                    { id: "documentId", label: "Document ID/Bates", type: "text", fullWidth: false },
                    { id: "documentDate", label: "Document Date", type: "text", fullWidth: false },
                    { id: "author", label: "Author", type: "text", fullWidth: false },
                    { id: "recipients", label: "Recipients", type: "text", fullWidth: false },
                    { id: "summaryText", label: "Summary", type: "textarea", fullWidth: true },
                    { id: "keyQuotes", label: "Key Quotes", type: "textarea", fullWidth: true },
                    { id: "significance", label: "Significance to Case", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract document summary information from this transcript. Return JSON with:
                    {"documentId": "", "documentDate": "", "author": "", "recipients": "", "summaryText": "", "keyQuotes": "", "significance": ""}`
            },
            "Identify patterns and connections": {
                title: "Patterns & Connections",
                icon: "fas fa-project-diagram",
                fields: [
                    { id: "communicationPatterns", label: "Communication Patterns", type: "textarea", fullWidth: true },
                    { id: "timelinePatterns", label: "Timeline Patterns", type: "textarea", fullWidth: true },
                    { id: "keyRelationships", label: "Key Relationships", type: "textarea", fullWidth: true },
                    { id: "inconsistencies", label: "Inconsistencies Found", type: "textarea", fullWidth: true },
                    { id: "patternNotes", label: "Analysis Notes", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract patterns and connections from this transcript. Return JSON with:
                    {"communicationPatterns": "", "timelinePatterns": "", "keyRelationships": "", "inconsistencies": "", "patternNotes": ""}`
            },
            "Prepare privilege log": {
                title: "Privilege Log",
                icon: "fas fa-clipboard-list",
                fields: [
                    { id: "batesNumber", label: "Bates Number", type: "text", fullWidth: false },
                    { id: "docDate", label: "Date", type: "text", fullWidth: false },
                    { id: "docAuthor", label: "Author", type: "text", fullWidth: false },
                    { id: "docRecipients", label: "Recipients", type: "text", fullWidth: false },
                    { id: "privilegeAsserted", label: "Privilege Asserted", type: "text", fullWidth: true },
                    { id: "privilegeBasis", label: "Basis for Privilege", type: "textarea", fullWidth: true },
                    { id: "docDescription", label: "Document Description", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract privilege log information from this transcript. Return JSON with:
                    {"batesNumber": "", "docDate": "", "docAuthor": "", "docRecipients": "", "privilegeAsserted": "", "privilegeBasis": "", "docDescription": ""}`
            },
            "Generate review report": {
                title: "Review Report",
                icon: "fas fa-chart-bar",
                fields: [
                    { id: "reviewScope", label: "Scope of Review", type: "textarea", fullWidth: true },
                    { id: "methodology", label: "Methodology Used", type: "textarea", fullWidth: true },
                    { id: "statsOverview", label: "Statistics Overview", type: "textarea", fullWidth: true },
                    { id: "keyFindings", label: "Key Findings", type: "textarea", fullWidth: true },
                    { id: "recommendations", label: "Recommendations", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract review report information from this transcript. Return JSON with:
                    {"reviewScope": "", "methodology": "", "statsOverview": "", "keyFindings": "", "recommendations": ""}`
            },
            // Deposition Summary Components
            "Review deposition transcript": {
                title: "Deposition Transcript Review",
                icon: "fas fa-file-alt",
                fields: [
                    { id: "deponentName", label: "Deponent Name", type: "text", fullWidth: false },
                    { id: "depositionDate", label: "Deposition Date", type: "text", fullWidth: false },
                    { id: "totalPages", label: "Total Pages", type: "text", fullWidth: false },
                    { id: "durationHours", label: "Duration (hours)", type: "text", fullWidth: false },
                    { id: "attendingCounsel", label: "Attending Counsel", type: "textarea", fullWidth: true },
                    { id: "initialImpressions", label: "Initial Impressions", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract deposition review information from this transcript. Return JSON with:
                    {"deponentName": "", "depositionDate": "", "totalPages": "", "durationHours": "", "attendingCounsel": "", "initialImpressions": ""}`
            },
            "Identify key testimony sections": {
                title: "Key Testimony Sections",
                icon: "fas fa-bookmark",
                fields: [
                    { id: "pageLineRefs", label: "Page:Line References", type: "textarea", fullWidth: true },
                    { id: "keyAdmissions", label: "Key Admissions", type: "textarea", fullWidth: true },
                    { id: "helpfulTestimony", label: "Helpful Testimony", type: "textarea", fullWidth: true },
                    { id: "damagingTestimony", label: "Damaging Testimony", type: "textarea", fullWidth: true },
                    { id: "topicsCovered", label: "Topics Covered", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract key testimony sections from this transcript. Return JSON with:
                    {"pageLineRefs": "", "keyAdmissions": "", "helpfulTestimony": "", "damagingTestimony": "", "topicsCovered": ""}`
            },
            "Highlight admissions and contradictions": {
                title: "Admissions & Contradictions",
                icon: "fas fa-exclamation-triangle",
                fields: [
                    { id: "admissionsList", label: "Admissions", type: "textarea", fullWidth: true },
                    { id: "contradictions", label: "Contradictions", type: "textarea", fullWidth: true },
                    { id: "priorInconsistent", label: "Prior Inconsistent Statements", type: "textarea", fullWidth: true },
                    { id: "impeachmentOpportunities", label: "Impeachment Opportunities", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract admissions and contradictions from this transcript. Return JSON with:
                    {"admissionsList": "", "contradictions": "", "priorInconsistent": "", "impeachmentOpportunities": ""}`
            },
            "Note objections and rulings": {
                title: "Objections & Rulings",
                icon: "fas fa-hand-paper",
                fields: [
                    { id: "objectionsRaised", label: "Objections Raised", type: "textarea", fullWidth: true },
                    { id: "objectingParty", label: "Objecting Party", type: "text", fullWidth: true },
                    { id: "rulings", label: "Rulings (if any)", type: "textarea", fullWidth: true },
                    { id: "instructionsToWitness", label: "Instructions to Witness", type: "textarea", fullWidth: true },
                    { id: "mattersReserved", label: "Matters Reserved", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract objections and rulings from this transcript. Return JSON with:
                    {"objectionsRaised": "", "objectingParty": "", "rulings": "", "instructionsToWitness": "", "mattersReserved": ""}`
            },
            "Extract quotes for potential use": {
                title: "Quotable Testimony",
                icon: "fas fa-quote-left",
                fields: [
                    { id: "quote1", label: "Key Quote 1 (with page:line)", type: "textarea", fullWidth: true },
                    { id: "quote2", label: "Key Quote 2 (with page:line)", type: "textarea", fullWidth: true },
                    { id: "quote3", label: "Key Quote 3 (with page:line)", type: "textarea", fullWidth: true },
                    { id: "quoteContext", label: "Context for Quotes", type: "textarea", fullWidth: true },
                    { id: "potentialUse", label: "Potential Use at Trial", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract quotable testimony from this transcript. Return JSON with:
                    {"quote1": "", "quote2": "", "quote3": "", "quoteContext": "", "potentialUse": ""}`
            },
            "Summarize each major topic": {
                title: "Topic Summary",
                icon: "fas fa-list-alt",
                fields: [
                    { id: "topicName", label: "Topic Name", type: "text", fullWidth: true },
                    { id: "pageRange", label: "Page Range", type: "text", fullWidth: false },
                    { id: "lineRange", label: "Line Range", type: "text", fullWidth: false },
                    { id: "topicSummary", label: "Summary", type: "textarea", fullWidth: true },
                    { id: "keyPoints", label: "Key Points", type: "textarea", fullWidth: true },
                    { id: "caseSignificance", label: "Significance to Case", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract topic summary from this transcript. Return JSON with:
                    {"topicName": "", "pageRange": "", "lineRange": "", "topicSummary": "", "keyPoints": "", "caseSignificance": ""}`
            },
            "Create index of important topics": {
                title: "Topic Index",
                icon: "fas fa-list-ol",
                fields: [
                    { id: "topicList", label: "Topic List with Page References", type: "textarea", fullWidth: true },
                    { id: "witnessBackground", label: "Witness Background (pages)", type: "text", fullWidth: true },
                    { id: "factualIssues", label: "Factual Issues (pages)", type: "text", fullWidth: true },
                    { id: "damagesDiscussed", label: "Damages Discussed (pages)", type: "text", fullWidth: true },
                    { id: "otherTopics", label: "Other Key Topics", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract topic index from this transcript. Return JSON with:
                    {"topicList": "", "witnessBackground": "", "factualIssues": "", "damagesDiscussed": "", "otherTopics": ""}`
            },
            "Cross-reference with other evidence": {
                title: "Evidence Cross-Reference",
                icon: "fas fa-link",
                fields: [
                    { id: "relatedDocuments", label: "Related Documents", type: "textarea", fullWidth: true },
                    { id: "otherDepositions", label: "Other Depositions Referenced", type: "textarea", fullWidth: true },
                    { id: "physicalEvidence", label: "Physical Evidence", type: "textarea", fullWidth: true },
                    { id: "consistencies", label: "Consistencies with Other Evidence", type: "textarea", fullWidth: true },
                    { id: "discrepancies", label: "Discrepancies Found", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract cross-reference information from this transcript. Return JSON with:
                    {"relatedDocuments": "", "otherDepositions": "", "physicalEvidence": "", "consistencies": "", "discrepancies": ""}`
            },
            "Format for attorney review": {
                title: "Attorney Review Format",
                icon: "fas fa-user-tie",
                fields: [
                    { id: "executiveSummary", label: "Executive Summary", type: "textarea", fullWidth: true },
                    { id: "criticalFindings", label: "Critical Findings", type: "textarea", fullWidth: true },
                    { id: "actionItems", label: "Action Items", type: "textarea", fullWidth: true },
                    { id: "followUpNeeded", label: "Follow-Up Needed", type: "textarea", fullWidth: true },
                    { id: "trialPrep", label: "Trial Preparation Notes", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract attorney review information from this transcript. Return JSON with:
                    {"executiveSummary": "", "criticalFindings": "", "actionItems": "", "followUpNeeded": "", "trialPrep": ""}`
            },
            "Prepare condensed version for trial": {
                title: "Trial Condensed Version",
                icon: "fas fa-compress-alt",
                fields: [
                    { id: "trialExcerpts", label: "Trial Excerpts (page:line)", type: "textarea", fullWidth: true },
                    { id: "designations", label: "Designations", type: "textarea", fullWidth: true },
                    { id: "counterDesignations", label: "Anticipated Counter-Designations", type: "textarea", fullWidth: true },
                    { id: "videoClips", label: "Video Clips to Prepare", type: "textarea", fullWidth: true },
                    { id: "exhibitsTie", label: "Exhibits to Tie In", type: "textarea", fullWidth: true }
                ],
                extractionPrompt: `Extract trial preparation information from this transcript. Return JSON with:
                    {"trialExcerpts": "", "designations": "", "counterDesignations": "", "videoClips": "", "exhibitsTie": ""}`
            }
        };

        // Default form for components without specific definitions
        const defaultComponentForm = {
            title: "Component Information",
            icon: "fas fa-clipboard",
            fields: [
                { id: "notes", label: "Notes", type: "textarea", fullWidth: true },
                { id: "keyPoints", label: "Key Points", type: "textarea", fullWidth: true },
                { id: "actionItems", label: "Action Items", type: "textarea", fullWidth: true },
                { id: "references", label: "References", type: "textarea", fullWidth: true }
            ],
            extractionPrompt: `Extract relevant information from this transcript. Return JSON with:
                {"notes": "", "keyPoints": "", "actionItems": "", "references": ""}`
        };

        // Open side panel for a component
        function openComponentPanel(componentName) {
            currentComponent = componentName;
            const formDef = componentForms[componentName] || defaultComponentForm;

            // Set title
            document.getElementById('sidePanelTitle').textContent = componentName;
            document.getElementById('componentFormTitle').textContent = formDef.title;

            // Generate form HTML
            const formContainer = document.getElementById('componentFormContainer');
            formContainer.innerHTML = generateFormHTML(formDef.fields);

            // Load existing data if any
            if (componentDataStore[componentName]) {
                loadComponentFormData(componentDataStore[componentName]);
            }

            // Reset audio state
            resetComponentAudioState();

            // Show panel
            document.getElementById('sidePanelOverlay').classList.add('active');
            document.getElementById('sidePanel').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSidePanel() {
            document.getElementById('sidePanelOverlay').classList.remove('active');
            document.getElementById('sidePanel').classList.remove('active');
            document.body.style.overflow = '';

            // Stop any recording
            if (componentMediaRecorder && componentMediaRecorder.state === 'recording') {
                componentMediaRecorder.stop();
            }
            clearInterval(componentRecordingTimer);
        }

        function generateFormHTML(fields) {
            let html = '<div class="component-form-grid two-col">';
            fields.forEach(field => {
                const fullWidthClass = field.fullWidth ? ' full-width' : '';
                html += `<div class="component-field${fullWidthClass}">`;
                html += `<label for="cf_${field.id}">${field.label}</label>`;

                if (field.type === 'textarea') {
                    html += `<textarea id="cf_${field.id}" placeholder="Enter ${field.label.toLowerCase()}..."></textarea>`;
                } else if (field.type === 'select') {
                    html += `<select id="cf_${field.id}">`;
                    html += `<option value="">Select...</option>`;
                    (field.options || []).forEach(opt => {
                        html += `<option value="${opt}">${opt}</option>`;
                    });
                    html += `</select>`;
                } else {
                    html += `<input type="${field.type || 'text'}" id="cf_${field.id}" placeholder="Enter ${field.label.toLowerCase()}...">`;
                }
                html += '</div>';
            });
            html += '</div>';
            return html;
        }

        function loadComponentFormData(data) {
            Object.keys(data).forEach(key => {
                const el = document.getElementById(`cf_${key}`);
                if (el) el.value = data[key];
            });
        }

        function resetComponentAudioState() {
            componentAudioFile = null;
            componentRecordedBlob = null;
            componentRecordingSeconds = 0;

            document.getElementById('componentDropZone').style.display = 'block';
            document.getElementById('componentSelectedFile').style.display = 'none';
            document.getElementById('componentTranscriptArea').style.display = 'none';
            document.getElementById('componentTranscriptText').value = '';
            document.getElementById('componentPasteTranscript').value = '';
            document.getElementById('componentRecordingTime').textContent = '00:00';
            document.getElementById('componentRecordingStatus').textContent = 'Click to record';
            document.getElementById('componentRecordBtn').classList.remove('recording');
            document.getElementById('componentRecordIcon').className = 'fas fa-microphone';

            // Reset tabs
            switchComponentTab('upload');
        }

        function switchComponentTab(tabName) {
            document.querySelectorAll('.component-audio-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.component-tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-ctab="${tabName}"]`).classList.add('active');
            document.getElementById(`ctab-${tabName}`).classList.add('active');
        }

        // File upload for component panel
        function setupComponentFileUpload() {
            const dropZone = document.getElementById('componentDropZone');
            const fileInput = document.getElementById('componentAudioFile');

            if (!dropZone || !fileInput) return;

            dropZone.addEventListener('click', () => fileInput.click());

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
                dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); });
            });

            ['dragenter', 'dragover'].forEach(evt => {
                dropZone.addEventListener(evt, () => dropZone.classList.add('dragover'));
            });

            ['dragleave', 'drop'].forEach(evt => {
                dropZone.addEventListener(evt, () => dropZone.classList.remove('dragover'));
            });

            dropZone.addEventListener('drop', e => {
                if (e.dataTransfer.files.length > 0) {
                    handleComponentFile(e.dataTransfer.files[0]);
                }
            });

            fileInput.addEventListener('change', e => {
                if (e.target.files.length > 0) {
                    handleComponentFile(e.target.files[0]);
                }
            });
        }

        function handleComponentFile(file) {
            if (file.size > 25 * 1024 * 1024) {
                showComponentStatus('File too large (max 25MB)', 'error');
                return;
            }
            componentAudioFile = file;
            componentRecordedBlob = null;
            document.getElementById('componentFileName').textContent = file.name;
            document.getElementById('componentDropZone').style.display = 'none';
            document.getElementById('componentSelectedFile').style.display = 'flex';
        }

        function removeComponentFile() {
            componentAudioFile = null;
            document.getElementById('componentAudioFile').value = '';
            document.getElementById('componentDropZone').style.display = 'block';
            document.getElementById('componentSelectedFile').style.display = 'none';
        }

        // Recording for component panel
        async function toggleComponentRecording() {
            const btn = document.getElementById('componentRecordBtn');
            const icon = document.getElementById('componentRecordIcon');
            const status = document.getElementById('componentRecordingStatus');

            if (componentMediaRecorder && componentMediaRecorder.state === 'recording') {
                componentMediaRecorder.stop();
                btn.classList.remove('recording');
                icon.className = 'fas fa-microphone';
                status.textContent = 'Recording saved';
                clearInterval(componentRecordingTimer);
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    componentMediaRecorder = new MediaRecorder(stream);
                    let chunks = [];

                    componentMediaRecorder.ondataavailable = e => chunks.push(e.data);
                    componentMediaRecorder.onstop = () => {
                        componentRecordedBlob = new Blob(chunks, { type: 'audio/webm' });
                        componentAudioFile = null;
                        stream.getTracks().forEach(t => t.stop());
                    };

                    componentMediaRecorder.start();
                    btn.classList.add('recording');
                    icon.className = 'fas fa-stop';
                    status.textContent = 'Recording...';
                    componentRecordingSeconds = 0;

                    componentRecordingTimer = setInterval(() => {
                        componentRecordingSeconds++;
                        const m = Math.floor(componentRecordingSeconds / 60);
                        const s = componentRecordingSeconds % 60;
                        document.getElementById('componentRecordingTime').textContent =
                            `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                        if (componentRecordingSeconds >= 300) toggleComponentRecording();
                    }, 1000);
                } catch (err) {
                    showComponentStatus('Could not access microphone', 'error');
                }
            }
        }

        function useComponentTranscript() {
            const text = document.getElementById('componentPasteTranscript').value.trim();
            if (!text) {
                showComponentStatus('No transcript text provided', 'error');
                return;
            }
            document.getElementById('componentTranscriptText').value = text;
            document.getElementById('componentTranscriptArea').style.display = 'block';
        }

        async function transcribeComponentAudio() {
            const openaiKey = localStorage.getItem('paralegal_openai_key');
            if (!openaiKey) {
                showComponentStatus('Please add OpenAI API key in Settings', 'error');
                return;
            }

            const audio = componentAudioFile || componentRecordedBlob;
            if (!audio) {
                showComponentStatus('Please upload or record audio first', 'error');
                return;
            }

            showProcessing('Transcribing Audio', 'Converting speech to text...');

            try {
                const formData = new FormData();
                formData.append('file', audio, audio.name || 'recording.webm');
                formData.append('model', 'whisper-1');

                const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${openaiKey}` },
                    body: formData
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || 'Transcription failed');
                }

                const result = await response.json();
                document.getElementById('componentTranscriptText').value = result.text;
                document.getElementById('componentTranscriptArea').style.display = 'block';
                hideProcessing();
                showComponentStatus('Transcription complete!', 'success');
            } catch (err) {
                hideProcessing();
                showComponentStatus(`Error: ${err.message}`, 'error');
            }
        }

        async function extractComponentInfo() {
            const transcript = document.getElementById('componentTranscriptText').value.trim();
            if (!transcript) {
                showComponentStatus('No transcript to extract from', 'error');
                return;
            }

            const formDef = componentForms[currentComponent] || defaultComponentForm;
            const extractionModel = localStorage.getItem('paralegal_extraction_model') || 'gpt-4o';
            const isClaudeModel = extractionModel.startsWith('claude');
            const apiKey = isClaudeModel
                ? localStorage.getItem('paralegal_anthropic_key')
                : localStorage.getItem('paralegal_openai_key');

            if (!apiKey) {
                showComponentStatus(`Please add ${isClaudeModel ? 'Anthropic' : 'OpenAI'} API key`, 'error');
                return;
            }

            showProcessing('Extracting Information', `Analyzing with ${extractionModel}...`);

            const prompt = `You are a legal assistant. Analyze the following transcript for the task: "${currentComponent}".

${formDef.extractionPrompt}

TRANSCRIPT:
${transcript}

Respond with ONLY valid JSON, no additional text.`;

            try {
                let result;

                if (isClaudeModel) {
                    const modelId = extractionModel === 'claude-sonnet' ? 'claude-sonnet-4-20250514' : 'claude-3-5-haiku-20241022';
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01',
                            'anthropic-dangerous-direct-browser-access': 'true'
                        },
                        body: JSON.stringify({
                            model: modelId,
                            max_tokens: 4096,
                            messages: [{ role: 'user', content: prompt }]
                        })
                    });

                    if (!response.ok) throw new Error('Extraction failed');
                    const data = await response.json();
                    result = JSON.parse(data.content[0].text);
                } else {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: extractionModel,
                            messages: [{ role: 'user', content: prompt }],
                            response_format: { type: 'json_object' }
                        })
                    });

                    if (!response.ok) throw new Error('Extraction failed');
                    const data = await response.json();
                    result = JSON.parse(data.choices[0].message.content);
                }

                loadComponentFormData(result);
                hideProcessing();
                showComponentStatus('Information extracted!', 'success');
            } catch (err) {
                hideProcessing();
                showComponentStatus(`Error: ${err.message}`, 'error');
            }
        }

        function getComponentFormData() {
            const formDef = componentForms[currentComponent] || defaultComponentForm;
            const data = {};
            formDef.fields.forEach(field => {
                const el = document.getElementById(`cf_${field.id}`);
                if (el) data[field.id] = el.value;
            });
            return data;
        }

        function saveComponentData() {
            if (!currentComponent) return;
            const data = getComponentFormData();
            componentDataStore[currentComponent] = data;

            // Mark component as having data in the breakdown list
            document.querySelectorAll('.component-item').forEach(item => {
                if (item.querySelector('.component-text')?.textContent === currentComponent) {
                    item.classList.add('has-data');
                }
            });

            showComponentStatus('Data saved!', 'success');
        }

        function copyComponentData() {
            const data = getComponentFormData();
            const formDef = componentForms[currentComponent] || defaultComponentForm;

            let text = `${currentComponent}\n${'='.repeat(currentComponent.length)}\n\n`;
            formDef.fields.forEach(field => {
                if (data[field.id]) {
                    text += `${field.label}:\n${data[field.id]}\n\n`;
                }
            });

            navigator.clipboard.writeText(text).then(() => {
                showComponentStatus('Copied to clipboard!', 'success');
            });
        }

        function clearComponentForm() {
            if (confirm('Clear all fields?')) {
                const formDef = componentForms[currentComponent] || defaultComponentForm;
                formDef.fields.forEach(field => {
                    const el = document.getElementById(`cf_${field.id}`);
                    if (el) el.value = '';
                });
            }
        }

        function showComponentStatus(msg, type) {
            const el = document.getElementById('componentStatus');
            el.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i> ${msg}`;
            el.className = `component-status show ${type}`;
            setTimeout(() => el.classList.remove('show'), 4000);
        }

        // ============================================
        // ORIGINAL TASK DECONSTRUCTION FUNCTIONALITY
        // ============================================

        // Example tasks data
        const exampleTasks = {
            "Draft a complaint for a civil lawsuit": {
                level1: [
                    "Review case facts and client information",
                    "Identify proper jurisdiction and venue",
                    "Determine causes of action",
                    "Research applicable laws and precedents",
                    "Draft caption and parties section",
                    "Write factual allegations",
                    "Formulate legal claims",
                    "Draft prayer for relief",
                    "Include verification if required",
                    "Format according to court rules"
                ],
                level2: {
                    "Draft factual allegations": [
                        "Chronologically organize events",
                        "Include specific dates and locations",
                        "Identify all relevant parties",
                        "Describe actions and consequences",
                        "Cite supporting evidence",
                        "Ensure factual consistency"
                    ],
                    "Formulate legal claims": [
                        "Match facts to legal elements",
                        "Cite relevant statutes",
                        "Reference applicable case law",
                        "Avoid redundant claims",
                        "Check statute of limitations",
                        "Include all necessary parties"
                    ]
                },
                automation: [
                    {
                        title: "Document Assembly",
                        icon: "fas fa-file-contract",
                        description: "Automate repetitive drafting tasks",
                        components: ["Draft caption and parties section", "Format according to court rules", "Include verification if required"],
                        tools: ["Document automation software", "Template libraries", "Style checkers"],
                        potential: 85
                    },
                    {
                        title: "Legal Research",
                        icon: "fas fa-search",
                        description: "Streamline research processes",
                        components: ["Research applicable laws and precedents", "Cite relevant statutes", "Reference applicable case law"],
                        tools: ["AI-powered research tools", "Citation generators", "Statute databases"],
                        potential: 75
                    },
                    {
                        title: "Fact Organization",
                        icon: "fas fa-sitemap",
                        description: "Structure case facts efficiently",
                        components: ["Chronologically organize events", "Identify all relevant parties", "Ensure factual consistency"],
                        tools: ["Case management systems", "Timeline builders", "Fact organization software"],
                        potential: 70
                    }
                ]
            },
            "Conduct document review for discovery": {
                level1: [
                    "Receive document production from opposing party",
                    "Organize documents by source and date",
                    "Apply relevance criteria to filter documents",
                    "Identify privileged materials",
                    "Flag key documents for case strategy",
                    "Code documents for easy retrieval",
                    "Prepare document summaries",
                    "Identify patterns and connections",
                    "Prepare privilege log",
                    "Generate review report"
                ],
                level2: {
                    "Apply relevance criteria": [
                        "Review document against discovery requests",
                        "Identify responsive materials",
                        "Separate non-responsive documents",
                        "Apply keyword filters",
                        "Check for date range relevance",
                        "Evaluate subject matter relevance"
                    ],
                    "Code documents for easy retrieval": [
                        "Assign unique identifiers",
                        "Apply issue tags",
                        "Note key facts or evidence",
                        "Mark witness connections",
                        "Flag for attorney review",
                        "Create cross-references"
                    ]
                },
                automation: [
                    {
                        title: "Document Analysis",
                        icon: "fas fa-file-alt",
                        description: "Automate initial document screening",
                        components: ["Apply keyword filters", "Check for date range relevance", "Separate non-responsive documents"],
                        tools: ["AI document review platforms", "Predictive coding", "Text analytics tools"],
                        potential: 90
                    },
                    {
                        title: "Organization & Tagging",
                        icon: "fas fa-tags",
                        description: "Systematize document categorization",
                        components: ["Assign unique identifiers", "Apply issue tags", "Create cross-references"],
                        tools: ["Document management systems", "Automated tagging software", "Metadata extractors"],
                        potential: 80
                    },
                    {
                        title: "Reporting",
                        icon: "fas fa-chart-bar",
                        description: "Generate review summaries automatically",
                        components: ["Prepare document summaries", "Generate review report", "Identify patterns and connections"],
                        tools: ["Report generators", "Data visualization tools", "Analytics dashboards"],
                        potential: 75
                    }
                ]
            },
            "Prepare deposition summaries": {
                level1: [
                    "Review deposition transcript",
                    "Identify key testimony sections",
                    "Highlight admissions and contradictions",
                    "Note objections and rulings",
                    "Extract quotes for potential use",
                    "Summarize each major topic",
                    "Create index of important topics",
                    "Cross-reference with other evidence",
                    "Format for attorney review",
                    "Prepare condensed version for trial"
                ],
                level2: {
                    "Identify key testimony sections": [
                        "Locate answers to important questions",
                        "Find admissions against interest",
                        "Identify inconsistencies in testimony",
                        "Note evasive or non-responsive answers",
                        "Highlight helpful statements",
                        "Flag damaging testimony"
                    ],
                    "Summarize each major topic": [
                        "Paraphrase lengthy testimony",
                        "Maintain original meaning",
                        "Include page and line references",
                        "Note attorney questions",
                        "Connect related testimony",
                        "Indicate significance to case"
                    ]
                },
                automation: [
                    {
                        title: "Transcript Analysis",
                        icon: "fas fa-comment-dots",
                        description: "Automate review of deposition transcripts",
                        components: ["Identify admissions and contradictions", "Find inconsistencies in testimony", "Highlight helpful statements"],
                        tools: ["AI transcript analyzers", "Natural language processing", "Keyword highlighters"],
                        potential: 80
                    },
                    {
                        title: "Summary Generation",
                        icon: "fas fa-file-signature",
                        description: "Create draft summaries automatically",
                        components: ["Paraphrase lengthy testimony", "Create index of important topics", "Format for attorney review"],
                        tools: ["Summary generation software", "Template-based summarizers", "Automated formatting tools"],
                        potential: 70
                    },
                    {
                        title: "Cross-referencing",
                        icon: "fas fa-link",
                        description: "Connect testimony to other evidence",
                        components: ["Cross-reference with other evidence", "Connect related testimony", "Flag for attorney review"],
                        tools: ["Case linking software", "Evidence correlation tools", "Database connectors"],
                        potential: 65
                    }
                ]
            }
        };

        // DOM elements
        const taskInput = document.getElementById('taskInput');
        const deconstructBtn = document.getElementById('deconstructBtn');
        const exampleBtns = document.querySelectorAll('.example-btn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsContainer = document.getElementById('resultsContainer');
        const taskDisplay = document.getElementById('currentTask');
        const breakdownContainer = document.getElementById('breakdownContainer');
        const automationAnalysis = document.getElementById('automationAnalysis');
        const analysisGrid = document.getElementById('analysisGrid');

        // Event listeners
        deconstructBtn.addEventListener('click', deconstructTask);
        
        exampleBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const exampleText = this.getAttribute('data-example');
                taskInput.value = exampleText;
                deconstructTask();
            });
        });

        // Main function to deconstruct the task
        function deconstructTask() {
            const task = taskInput.value.trim();
            
            if (!task) {
                alert("Please enter a task to deconstruct.");
                taskInput.focus();
                return;
            }
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            resultsContainer.style.display = 'none';
            automationAnalysis.style.display = 'none';
            
            // Simulate processing time
            setTimeout(() => {
                processTask(task);
                loadingIndicator.style.display = 'none';
                resultsContainer.style.display = 'block';
            }, 800);
        }

        function processTask(task) {
            // Display the task
            taskDisplay.textContent = task;
            
            // Clear previous breakdown
            breakdownContainer.innerHTML = '';
            
            // Check if task is in our examples
            let taskData;
            if (exampleTasks[task]) {
                taskData = exampleTasks[task];
            } else {
                // Generate generic breakdown for unknown tasks
                taskData = generateGenericBreakdown(task);
            }
            
            // Create level 1 breakdown
            createBreakdownLevel("Primary Components", taskData.level1, 1);
            
            // Create level 2 breakdown if available
            if (taskData.level2) {
                for (const [category, components] of Object.entries(taskData.level2)) {
                    createBreakdownLevel(category, components, 2);
                }
            }
            
            // Add automation analysis if available
            if (taskData.automation) {
                createAutomationAnalysis(taskData.automation);
                automationAnalysis.style.display = 'block';
            }
            
            // Scroll to results
            breakdownContainer.scrollTop = 0;
        }

        function createBreakdownLevel(title, components, level) {
            const levelDiv = document.createElement('div');
            levelDiv.className = 'breakdown-level';

            const headerDiv = document.createElement('div');
            headerDiv.className = 'level-header';

            const titleSpan = document.createElement('span');
            titleSpan.className = 'level-title';
            titleSpan.textContent = title;

            const countSpan = document.createElement('span');
            countSpan.className = 'level-count';
            countSpan.textContent = `${components.length} components`;

            headerDiv.appendChild(titleSpan);
            headerDiv.appendChild(countSpan);

            const listDiv = document.createElement('div');
            listDiv.className = 'component-list';

            components.forEach(component => {
                const componentDiv = document.createElement('div');
                componentDiv.className = 'component-item clickable';

                // Make component clickable to open side panel
                componentDiv.addEventListener('click', () => {
                    openComponentPanel(component);
                });

                // Add has-data class if component has saved data
                if (componentDataStore[component]) {
                    componentDiv.classList.add('has-data');
                }

                const textDiv = document.createElement('div');
                textDiv.className = 'component-text';
                textDiv.textContent = component;

                componentDiv.appendChild(textDiv);

                // Randomly assign some components as automatable
                if (Math.random() > 0.6) {
                    const badge = document.createElement('span');
                    badge.className = 'automation-badge';
                    badge.textContent = 'Automatable';
                    componentDiv.appendChild(badge);
                }

                listDiv.appendChild(componentDiv);
            });

            levelDiv.appendChild(headerDiv);
            levelDiv.appendChild(listDiv);

            breakdownContainer.appendChild(levelDiv);
        }

        function createAutomationAnalysis(automationData) {
            analysisGrid.innerHTML = '';
            
            automationData.forEach(item => {
                const card = document.createElement('div');
                card.className = 'analysis-card';
                
                card.innerHTML = `
                    <h3><i class="${item.icon}"></i> ${item.title}</h3>
                    <p>${item.description}</p>
                    <p><strong>Components automated:</strong></p>
                    <ul>
                        ${item.components.map(comp => `<li>${comp}</li>`).join('')}
                    </ul>
                    <p><strong>Tools needed:</strong> ${item.tools.join(', ')}</p>
                    <div class="automation-potential">
                        <div class="potential-bar">
                            <div class="potential-fill" style="width: ${item.potential}%"></div>
                        </div>
                        <span>${item.potential}% automatable</span>
                    </div>
                `;
                
                analysisGrid.appendChild(card);
            });
        }

        function generateGenericBreakdown(task) {
            // Generate a generic breakdown for tasks not in our examples
            const words = task.split(' ');
            const action = words[0]; // First word is usually the action
            
            const genericBreakdown = {
                level1: [
                    `Gather requirements for ${task.toLowerCase()}`,
                    `Research relevant laws and regulations`,
                    `Collect necessary documents and information`,
                    `Analyze facts and apply to legal standards`,
                    `Draft initial ${action === 'Draft' ? 'document' : 'materials'}`,
                    `Review for accuracy and completeness`,
                    `Format according to legal standards`,
                    `Obtain necessary approvals`,
                    `Finalize and prepare for distribution`,
                    `Document the process for future reference`
                ],
                level2: {
                    "Research phase": [
                        "Identify applicable jurisdiction",
                        "Review relevant statutes",
                        "Check for recent case law",
                        "Consult secondary sources",
                        "Verify procedural requirements",
                        "Document research findings"
                    ],
                    "Drafting phase": [
                        "Create outline of key points",
                        "Incorporate legal standards",
                        "Apply facts to law",
                        "Include necessary elements",
                        "Use appropriate legal language",
                        "Cite authorities properly"
                    ]
                },
                automation: [
                    {
                        title: "Research Automation",
                        icon: "fas fa-search",
                        description: "Streamline legal research processes",
                        components: ["Research relevant laws and regulations", "Check for recent case law", "Document research findings"],
                        tools: ["AI research assistants", "Legal databases", "Citation managers"],
                        potential: 70
                    },
                    {
                        title: "Document Assembly",
                        icon: "fas fa-file-contract",
                        description: "Automate document creation",
                        components: ["Draft initial materials", "Format according to legal standards", "Include necessary elements"],
                        tools: ["Document automation software", "Template systems", "Style checkers"],
                        potential: 75
                    },
                    {
                        title: "Process Management",
                        icon: "fas fa-stream",
                        description: "Systematize workflow and tracking",
                        components: ["Document the process for future reference", "Obtain necessary approvals", "Prepare for distribution"],
                        tools: ["Workflow management systems", "Approval trackers", "Document management platforms"],
                        potential: 65
                    }
                ]
            };
            
            return genericBreakdown;
        }

        // Initialize with an example
        document.addEventListener('DOMContentLoaded', function() {
            taskInput.value = "Draft a complaint for a civil lawsuit";
            deconstructTask();
        });
    </script>
</body>
</html>